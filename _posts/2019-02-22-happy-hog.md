---
layout: post
title: happy hog
date:  2019-02-26
last_modified_at: 2019-04-01
project_date: 201511
summary: 반려동물의 관리 자동화 
categories: posts
---

# Happy Hog House

<div class='ui divider'></div>

## 개요

혼자 집을 지키고 있는 반려동물의 관리를 도와주는 시스템 개발. 자동 급식 외에 고슴도치와 같은 반려동물을 위해 온, 습도 조절 등을 가능하도록 지원함.

[소스코드(github)](https://github.com/MyHappyHog/ProjectPrototype)

<div class='ui divider'></div>

## 기술 스택

- Android
- Arduino / Server

<div class='ui divider'></div>

## 개발 내용 (안드로이드)

<div class='ui divider'></div>

### 급식기와 데이터 통신

**소개**

앱으로 온, 습도 및 급식 스케줄과 같은 설정을 하거나 확인하려면 데이터를 주고 받을 방법이 필요했음.  
급식기에서 AP모드[^1]로 주변에서 연결할 수 있지만 데이터를 근처에서 밖에 주고받지 못함.  
급식기를 와이파이에 연결해 서버로 만들 수 있지만 외부에서 접근하려면 포트포워딩을 하는 등의 사용자가 하기 복잡한 작업이 필요함.

따라서 외부의 저장소를 이용하기로 함. Dropbox API를 이용해 Dropbox로 데이터를 주고 받음. 데이터의 백업 효과도 있음.

**결과**

앱 처음화면에서 Dropbox 로그인. 앱에서 드랍박스에 있는 급식기 상태 데이터를 다운 받아서 사용자에게 보여줌. 앱에서 온, 습도 및 급식 스케줄링 세팅을 바꾸면 바뀐 값을 업로드.

![happyhog-app-dropbox](/images/happyhog-app-dropbox.png)

<div class='ui divider'></div>

### 반려동물 관리 기능

**소개**

반려동물 프로필의 등록, 수정, 삭제 기능. 등록하면서 급식기 정보 입력으로 급식기 초기 세팅.

**문제점**

반려동물을 등록하면서 급식기의 초기 세팅(와이파이)을 해야되는데 처음에는 사용자가 급식기의 AP로 접속해서 폼에 직접 입력했어야 했음.  
IP를 직접 입력해서 웹사이트를 통해 세팅해야해서 컴퓨터를 잘 모르는 사람 입장에서는 어려울 것이라는 생각이 들었음.

따라서 반려동물 등록시 입력된 급식기 정보로 자동으로 초기셋팅이 되도록 만듦.

**결과**

프로필 등록시 급식기와 와이파이 정보를 받음. 자동으로 급식기 AP에 접속해 급식기 서버에 와이파이 정보를 넘겨 주고 초기 세팅이 되도록 함.  
사용자가 따로 할 일 없이 와이파이 정보만 입력하면 한 번에 처리되므로 세팅이 쉬워졌음.

**아쉬운점**

급식기 하나에 여러 동물을 등록할 수 있어야되는데 한 동물에 하나의 급식기만 가능.  
반려동물 프로필 삭제했을 때 급식기 세팅 초기화 기능 부재.

<div class='ui divider'></div>

### 유튜브를 이용한 반려동물 동영상 보기

**소개**

반려동물이 잘 있는지 확인하기 위한 기능. 때로는 반려동물들의 귀여운 행동을 촬영할 수 있음. 남는 스마트폰으로 스트리밍 앱을 이용해 유튜브에 스트리밍을 하면 스트리밍 되고 있는 영상을 앱으로 볼 수 있음.
    
**결과**

웹뷰를 이용해 동영상 플레이 기능을 만듦. 실시간보다는 약간의 딜레이가 있지만 영상 시청은 큰 문제가 없었음.

**아쉬운 점**

캡쳐를 하면 영상 부분만 까맣게 나오며 캡쳐를 할 수 없었음. 스마트폰 기본 캡처 기능은 물론이고 코드단에서 캡처하는 방법으로도 해결하지 못 했음.

<div class='ui divider'></div>

### 페이스북 공유 기능 개발

**소개**

반려동물의 프로필을 이용해 정보를 공유함. 동영상을 보다가 캡쳐한 귀여운 사진을 올리기 위함.
   
**결과**  

Facebook 로그인 기능. Facebook API를 이용해 타임라인에 글쓰기 기능 개발.

<div class='ui divider'></div>

## 개발 내용 (아두이노)

<div class='ui divider'></div>

### 웹 서버

**소개**

급식기의 세팅을 변경하기 위한 웹 서버 개발
  
**결과**  

오픈소스 라이브러리를 이용해 웹 서버 개발. Form 위주의 웹사이트. 

<div class='ui divider'></div>

### 앱과 데이터 통신

**소개**

앱과 온, 습도, 급식 스케줄 정보를 주고받기 위한 기능. Dropbox를 통해 데이터를 주고받기로 함.

**문제점**

Dropbox HTTP API를 사용하는데 꼭 HTTPS를 사용했어야 함. 아두이노의 메모리 부족으로 HTTPS 통신이 어려웠음. (작동이 되다가도 갑자기 꺼지는 등..)

**해결방안**

메모리를 가능하면 적게 쓰도록 객체를 필요할 때 만들었다가 용도가 끝나면 바로 지우고(C++), 문자열을 최대한 줄이는 등 기계적으로 해결.

**결과**  

기계적으로 메모리 사용량을 줄이다보니 어느 순간부터 잘 작동됨. Dropbox에 현재 온, 습도 상태 등을 업로드. Dropbox를 모니터링하다가 세팅 값이 바뀌면 받아와서 반영.  

![happyhog-dispenser-dropbox](/images/happyhog-dispenser-dropbox.png)

비교적 성능이 좋은 컴퓨터로만 개발을 하다보니 메모리가 부족해서 HTTPS 통신이 어려운 환경을 경험하리라곤 생각해보지 못 했음. 

웹으로 생각해보자면 만들어 놓은 코드가 IE 낮은 버전에서는 안돌아가는 느낌이 이런걸까 생각이 듦.

**아쉬운 점**

단순히 메모리 부족이라고만 알아서 시도해보고 해결했을 뿐 정확히 어떻게 해결되었는지는 아직도 의문. 구글에서 찾아보아도 대부분 메모리가 문제라는 말만 많았음.

<div class='ui divider'></div>

### 데이터 통신에 쓰이는 코드 구조화

**소개**

객체지향인 c++ 언어를 사용하는 만큼 구조화 해보기 위함. 또한 이전에 리팩토링의 경험으로 가능하면 구조화된 코드를 만들고 싶었음.

데이터의 종류는 온, 습도, 와이파이 정보, 급식 스케줄 등이 있음. Dropbox 혹은 급식기 내부 FileSystem에 JSON으로 읽고 쓰여짐.

데이터 클래스는 Setting 클래스를 상속받아 serialize, deserialize를 구현하도록 함. 두 개의 함수로 클래스를 JSON data로 내보내거나 불러올 수 있음.

읽고 쓰는 클래스는 DateStore 클래스를 상속 받아 download와 upload를 구현하도록 함.

**결과**

DataStore 클래스는 upload와 download 함수 파라미터로 Setting 객체를 받음. (코드의 중복을 줄일 수 있음)  
Setting의 serialize와 deserialize를 이용해 데이터를 가져오거나 저장함.

![happyhog-data-class](/images/happyhog-data-class.png)

<div class='ui divider'></div>

## Footnotes

[^1]: AP 모드 : Access Point의 약자. 다른 기기가 와이파이를 이용하여 AP에 접속할 수 있음.
